

<!DOCTYPE html>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html" charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>xperiments.io</title>

<link rel="icon" type="image/x-icon" href="/favicon.ico">
<link rel="stylesheet" type="text/css" href="/styles/style.css">
<link rel="stylesheet" type="text/css" href="/styles/prism.css">
<link rel="stylesheet" type="text/css" href="/styles/nav.css">
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Oxygen:400,700">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui">

</head>

<body class="home-template tag-text tag-formatting blog-has-cover">
<a name="top"></a>
<svg display="none" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="80" height="32" viewBox="0 0 80 32">
    <defs>
        <g id="icon-github">
            <path class="path1" d="M21.088 18.096c-1.149 0-2.080 1.29-2.080 2.878 0 1.59 0.931 2.88 2.080 2.88s2.080-1.29 2.080-2.88c-0.002-1.59-0.933-2.878-2.080-2.878zM28.33 10.602c0.237-0.584 0.248-3.904-1.014-7.082 0 0-2.899 0.317-7.283 3.326-0.92-0.254-2.477-0.381-4.032-0.381-1.557 0-3.112 0.128-4.034 0.381-4.382-3.010-7.28-3.326-7.28-3.326-1.262 3.178-1.253 6.498-1.014 7.082-1.485 1.613-2.392 3.549-2.392 6.194 0 11.498 9.539 11.682 11.947 11.682 0.546 0 1.63 0.002 2.774 0.003 1.144-0.002 2.229-0.003 2.771-0.003 2.41 0 11.947-0.184 11.947-11.682 0-2.645-0.906-4.581-2.39-6.194zM16.045 27.064h-0.088c-6.035 0-10.736-0.72-10.736-6.586 0-1.405 0.498-2.709 1.674-3.79 1.966-1.803 5.29-0.848 9.062-0.848 0.014 0 0.030 0 0.045-0.002 0.016 0 0.030 0.002 0.043 0.002 3.773 0 7.098-0.955 9.062 0.848 1.176 1.082 1.672 2.386 1.672 3.79 0 5.866-4.698 6.586-10.734 6.586zM10.914 18.096c-1.149 0-2.080 1.29-2.080 2.878 0 1.59 0.931 2.88 2.080 2.88s2.080-1.29 2.080-2.88c0-1.59-0.931-2.878-2.080-2.878z" />
        </g>
        <g id="icon-twitter">
            <path class="path1" d="M30.72 6.869c-1.085 0.482-2.248 0.805-3.47 0.952 1.248-0.747 2.206-1.931 2.656-3.341-1.166 0.691-2.459 1.195-3.834 1.466-1.102-1.174-2.672-1.907-4.41-1.907-3.336 0-6.040 2.704-6.040 6.038 0 0.474 0.053 0.934 0.157 1.376-5.019-0.251-9.47-2.656-12.448-6.31-0.522 0.891-0.821 1.93-0.821 3.037 0 2.096 1.067 3.944 2.688 5.027-0.99-0.032-1.922-0.302-2.736-0.755 0 0.026 0 0.050 0 0.075 0 2.926 2.083 5.366 4.845 5.923-0.506 0.138-1.040 0.211-1.592 0.211-0.389 0-0.766-0.037-1.136-0.107 0.768 2.4 3 4.146 5.642 4.194-2.067 1.621-4.67 2.586-7.501 2.586-0.488 0-0.968-0.029-1.44-0.085 2.672 1.714 5.846 2.714 9.259 2.714 11.109 0 17.184-9.203 17.184-17.186 0-0.261-0.005-0.522-0.018-0.781 1.181-0.851 2.203-1.915 3.014-3.126z" />
        </g>
        <g id="xperiments.io">
            <path d="M27.961,82.996l19.83-16.636c0.639-0.506,0.959-1.292,0.959-2.362c0-1.067-0.319-1.854-0.957-2.359L27.962,45.001
            c-2.101-1.759-3.152-3.946-3.152-6.559c0-2.33,0.839-4.331,2.513-6.006c1.677-1.675,3.678-2.514,6.007-2.514
            c1.989,0,3.949,0.795,5.879,2.382l60.828,50.692c2.101,1.761,3.151,3.949,3.151,6.561c0,2.33-0.836,4.332-2.513,6.008
            c-1.674,1.675-3.677,2.513-6.005,2.513c-1.987,0-3.947-0.794-5.878-2.386L67.65,78.072c-1.246-1.032-2.404-1.548-3.48-1.548
            c-1.3,0-2.572,0.518-3.818,1.551L39.208,95.695c-1.93,1.589-3.889,2.383-5.878,2.383c-2.329,0-4.33-0.838-6.006-2.513
            c-1.674-1.676-2.513-3.678-2.513-6.008C24.811,86.944,25.861,84.757,27.961,82.996z M78.24,41.098l10.55-8.794
            c1.932-1.587,3.892-2.382,5.879-2.382c2.33,0,4.333,0.839,6.007,2.514c1.677,1.676,2.513,3.677,2.513,6.006
            c0,2.614-1.05,4.8-3.151,6.561l-9.818,8.068c-1.985,1.664-3.971,2.494-5.956,2.494c-1.475,0-2.579-0.141-3.318-0.424
            c-0.737-0.283-1.646-0.965-2.724-2.043c-1.643-1.646-2.466-3.632-2.466-5.959C75.757,44.473,76.585,42.458,78.24,41.098z" stroke="rgba(0,0,0,.3)" stroke-width="4"/>
        </g>
		<g id="tag">
			<path d="M31.391 13.883l-5-8c-0.73-1.169-2.012-1.88-3.391-1.88h-19c-2.209 0-4 1.791-4 4v16c0 2.209 1.791 4 4 4h19c1.379 0 2.66-0.711 3.391-1.881l5-8c0.812-1.295 0.812-2.942 0-4.239zM29.695 17.062l-5 8.002c-0.367 0.588-1.002 0.939-1.695 0.939h-19c-1.103 0-2-0.898-2-2v-16c0-1.103 0.897-2 2-2h19c0.693 0 1.328 0.352 1.695 0.939l5 8c0.403 0.645 0.403 1.477 0 2.12zM23 13.003c-1.658 0-3 1.343-3 3s1.342 3 3 3c1.656 0 3-1.344 3-3 0-1.657-1.344-3-3-3zM23 18.004c-1.105 0-2-0.896-2-2s0.895-2 2-2c1.104 0 2 0.896 2 2s-0.896 2-2 2z"></path>
		</g>
    </defs>
</svg>
<nav id="bt-menu" class="bt-menu">
    <a class="bt-menu-trigger"><svg style="width:40px; height:40px; fill:FFF; " viewBox="0 0 128 128"><circle cx="64" fill-opacity=".1" stroke-width="1" cy="64.001" r="64"/><use xlink:href="#xperiments.io"></use></a>
    <ul>
        <li><a href="/pages/about">About</a></li>
        <li><a href="/">Blog</a></li>
        <li><a href="/archives.html">Archives</a></li>
        <li><a href="/pages/projects">Projects</a></li>
    </ul>
    <ul>
        <li><a href="//github.com/xperiments" target="_blank" class="bt-icon"><svg style="width:32px; height:32px;" viewBox="0 0 32 32"><use xlink:href="#icon-github"></use></svg></a></li>
        <li><a href="//twitter.com/@xperiments" target="_blank" class="bt-icon"><svg style="width:32px; height:32px;" viewBox="0 0 32 32"><use xlink:href="#icon-twitter"></use></svg></a></li>
    </ul>

</nav>









<div class="blog-cover" style="position:relative; background-image: url(/images/-1515626995.jpg);background-size: cover;background-position: center;">
    <div class="xp-cover-gradient"></div>
    <header class="xp-post-info">
        <span href="/posts/typescript-angularjs-best-practices/">@xperiments <time datetime="Wed Jul 16 2014 00:00:00 GMT+0200 (CEST)"> July 16, 2014</time>.</span><br/>
    </header>
    <header class="xp-cover xp-antialiased">
        <h1 class="post-title">Typescript AngularJS Best Practices</h1>
        <h3>#001 Injections</h3> 
		<h4><svg style="width:22px; height:22px; fill:#FFF; margin-bottom:-6px;" viewBox="0 0 32 32"><use xlink:href="#tag"></use></svg> Typescript</h4> 
		<div class="xp-cover-arrow">v</div>
    </header>
</div>

<!-- header class="site-header">
    <a class="blog-logo" href="/"><img src="/images/logo.svg" alt="Blog Logo" /></a>
</header -->
<main class="site-content" role="main">

    <article class="post tag-text tag-formatting">


        <section class="post-content">

                    <h2 id="introduction">Introduction</h2>
<p>I will write a series of posts about some working practices I have found helpful while developing AngularJS apps with Typescript.
If you consider that something is wrong or could be improved, just leave a message in the corresponding post and I will update it.</p>
<h1 id="-001-injections">#001 Injections</h1>
<p>Lately I&#39;ve been struggling with a bug in AngularJS which has given me a good number of headaches.</p>
<p>Consider this Controller class:</p>
<pre><code class="language-javascript">class MyController
{
    static $inject = ["$scope","$elenent","$attr"];
    constructor( $scope, $attr, $element )
    {
    }

}</code></pre><p>Seems correct at first time, also give no Typescript compiler time error. </p>
<p>Inspecting carefully our class we can find 2 errors:</p>
<h3 id="-element-is-misspelled">$element is misspelled</h3>
<pre><code class="language-javascript">static $inject = ["$scope", --> "$elenent" <-- ,"$attr"];</code></pre><h3 id="injection-between-constructor-inject-not-in-sync">injection between constructor &amp; $inject not in Sync</h3>
<pre><code class="language-javascript">$inject:        "$scope", --> "$elenent","$attr" <--
constructor:    "$scope", --> "$attr", "$element" <--</code></pre><h2 id="best-practices-to-overcome-this-errors-">Best practices to Overcome this errors:</h2>
<h3 id="misspelling">Misspelling</h3>
<p>To avoid the misspelling and benefit of IDE code completion I suggest to use a static class to hold all AngularJS injection properties &quot;names&quot;.</p>
<p>Let&#39;s define a simple class to hold the name values:</p>
<pre><code class="language-javascript">module $di
{
    export class $ng
    {
        ...
        public static $scope:string = null;
        public static $element:string = null;
        public static $attr:string = null;
        ...
    }

    $di.initStaticClass( $ng );
}</code></pre><p><strong>full $di source code at bottom</strong> or at <a href="https://gist.github.com/xperiments/5dff26e1ab673b74194d">Gist</a></p>
<p>Calling the $di.initStaticClass( $ng ); will set the value of every property to his own keyname, resulting in:</p>
<pre><code class="language-javascript">    ...
    public static $scope:string = "$scope";
    public static $element:string = "$element";
    public static $attr:string = "$attr";
    ...</code></pre><blockquote>
<p>Note here we are initializing all the properties of $ng class to null. This is required to be able to initialize the values with the $di.initStaticClass method.</p>
</blockquote>
<p>Later at our MyController class we can then reference the static properties like:</p>
<pre><code class="language-javascript">class MyController
{
    static $inject =
    [
        $di.$ng.$scope,
        $di.$ng.$element
        $di.$ng.$attr
    ];
    constructor( $scope, $element, $attr )
    {
    }

}</code></pre><h3 id="injection-between-constructor-inject-not-in-sync">injection between constructor &amp; $inject not in Sync</h3>
<p>This is the cause of some difficult to find bugs, because sometimes injection is working but not in the correct order or some parameters are missing.</p>
<p>To avoid this the $di code at bottom provides with a helper method <strong>$di.checkDI</strong> that let us check the correct injection value/order at runtime.</p>
<p>To test MyController and check the injection correctness do:  </p>
<pre><code class="language-javascript">
// this will Fail as $element is not in order
class MyControllerFail
{
    static $inject =
    [
        $di.$ng.$scope,
        $di.$ng.$element
        $di.$ng.$attr
    ];
    constructor( $scope, $attr, $element )
    {
    }

}
$di.checkDI( MyControllerFail );

// this will Pass as $element is in order
class MyController
{
    static $inject =
    [
        $di.$ng.$scope,
        $di.$ng.$element
        $di.$ng.$attr
    ];
    constructor( $scope, $element, $attr )
    {
    }

}
$di.checkDI( MyController );</code></pre><p>And finally the <a href="https://gist.github.com/xperiments/5dff26e1ab673b74194d">Gist</a> and full source code of the $di module:</p>
<pre><code class="language-typescript">
/**
 * $di.ts
 * http://www.xperiments.io/posts/typescript-angularjs-best-practices/
 * Created by xperiments on 15/07/14.
 */
module $di
{
    /* service */
    export class $ng
    {
        /* Services */
        static $anchorScroll:string = null;
        static $animate:string = null;
        static $cacheFactory:string = null;
        static $compile:string = null;
        static $controller:string = null;
        static $document:string = null;
        static $filter:string = null;
        static $http:string = null;
        static $interpolate:string = null;
        static $locale:string = null;
        static $location:string = null;
        static $parse:string = null;
        static $q:string = null;
        static $rootElement:string = null;
        static $rootScope:string = null;
        static $sce:string = null;
        static $sceDelegate:string = null;
        static $templateCache:string = null;
        static $window:string = null;
        static $exceptionHandler:string = null;
        static $httpBackend:string = null;
        static $interval:string = null;
        static $log:string = null;
        static $timeout:string = null;
        static $resource:string = null;
        static $sanitize:string = null;
        static $swipe:string = null;


        /* providers */
        static $animateProvider:string = null;
        static $compileProvider:string = null;
        static $controllerProvider:string = null;
        static $filterProvider:string = null;
        static $httpProvider:string = null;
        static $interpolateProvider:string = null;
        static $locationProvider:string = null;
        static $logProvider:string = null;
        static $parseProvider:string = null;
        static $rootScopeProvider:string = null;
        static $sceDelegateProvider:string = null;
        static $sceProvider:string = null;
        static $exceptionHandlerProvider:string = null;
        static $routeProvider:string = null;

        /* auto */
        static $injector:string = null;
        static $provide:string = null;

        /* ngCookies service */
        static $cookieStore:string = null;
        static $cookies:string = null;


        /* ngRoute service */
        static $route:string = null;
        static $routeParams:string = null;

        /* controller */
        static $scope:string = null;
        static $element:string = null;
        static $attrs:string = null;
        static $transclude:string = null;

    }
    export module $ng
    {
        initStaticClass( $ng );
    }



    var __dev_mode:boolean = false;
    export function setDevelopment(devMode:boolean){ __dev_mode = devMode }

    /* HELPERS */
    export function initStaticClass( Class:any ):void
    {
        // sets the same value from the keyname itself
        // bypassing not nulled properties
        Object.keys(Class).forEach((key:string)=> { (Class[key] === null) && ( Class[key] = key ); })
    }
    export function checkDI( Class:Function ):void
    {
        if( !__dev_mode ) return; // Do nothing in production!!

        // do a dity check here :-(
        var className:string = getClassName(Class);
        if ( annotate(Class).toString().toLowerCase()!=Class.$inject.toString().toLowerCase() )
        {
            var err = ("\n\nPlease check the injection in class $className$\n\n").replace('$className$',className);
            throw new Error(err);
            return;
        }
        console.log('$di class checked: '+className)
    };

    /** INTERNAL **/
    function getClassName(Class:any):string
    {
        return Class.toString().match(/function (.*)\(/)[1];
    }

    //http://taoofcode.net/studying-the-angular-injector-annotate/
    var FN_ARGS:RegExp = /^function\s*[^\(]*\(\s*([^\)]*)\)/m;
    var FN_ARG_SPLIT:RegExp = /,/;
    var FN_ARG:RegExp = /^\s*(_?)(\S+?)\1\s*$/;
    var STRIP_COMMENTS:RegExp = /((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg;

    function annotate(fn:Function):string[]
    {
        var $inject:string[];
        var fnText:string;
        var argDecl:any[];

        if (typeof fn == 'function') {

            $inject = [];
            if (fn.length) {
                fnText = fn.toString().replace(STRIP_COMMENTS, '');
                argDecl = fnText.match(FN_ARGS);
                argDecl[1].split(FN_ARG_SPLIT).forEach(function(arg){
                    arg.replace(FN_ARG, function(all, underscore, name){
                        $inject.push(name);
                    });
                });
            }
        }
        return $inject;
    }
}</code></pre><div xp-code-play="typescript"><pre>
/**
 * $di.ts
 * http://www.xperiments.io/posts/typescript-angularjs-best-practices/
 * Created by xperiments on 15/07/14.
 */
module $di
{
    /* service */
    export class $ng
    {
        /* Services */
        static $anchorScroll:string = null;
        static $animate:string = null;
        static $cacheFactory:string = null;
        static $compile:string = null;
        static $controller:string = null;
        static $document:string = null;
        static $filter:string = null;
        static $http:string = null;
        static $interpolate:string = null;
        static $locale:string = null;
        static $location:string = null;
        static $parse:string = null;
        static $q:string = null;
        static $rootElement:string = null;
        static $rootScope:string = null;
        static $sce:string = null;
        static $sceDelegate:string = null;
        static $templateCache:string = null;
        static $window:string = null;
        static $exceptionHandler:string = null;
        static $httpBackend:string = null;
        static $interval:string = null;
        static $log:string = null;
        static $timeout:string = null;
        static $resource:string = null;
        static $sanitize:string = null;
        static $swipe:string = null;


        /* providers */
        static $animateProvider:string = null;
        static $compileProvider:string = null;
        static $controllerProvider:string = null;
        static $filterProvider:string = null;
        static $httpProvider:string = null;
        static $interpolateProvider:string = null;
        static $locationProvider:string = null;
        static $logProvider:string = null;
        static $parseProvider:string = null;
        static $rootScopeProvider:string = null;
        static $sceDelegateProvider:string = null;
        static $sceProvider:string = null;
        static $exceptionHandlerProvider:string = null;
        static $routeProvider:string = null;

        /* auto */
        static $injector:string = null;
        static $provide:string = null;

        /* ngCookies service */
        static $cookieStore:string = null;
        static $cookies:string = null;


        /* ngRoute service */
        static $route:string = null;
        static $routeParams:string = null;

        /* controller */
        static $scope:string = null;
        static $element:string = null;
        static $attrs:string = null;
        static $transclude:string = null;

    }
    export module $ng
    {
        initStaticClass( $ng );
    }



    var __dev_mode:boolean = false;
    export function setDevelopment(devMode:boolean){ __dev_mode = devMode }

    /* HELPERS */
    export function initStaticClass( Class:any ):void
    {
        // sets the same value from the keyname itself
        // bypassing not nulled properties
        Object.keys(Class).forEach((key:string)=> { (Class[key] === null) && ( Class[key] = key ); })
    }
    export function checkDI( Class:Function ):void
    {
        if( !__dev_mode ) return; // Do nothing in production!!

        // do a dity check here :-(
        var className:string = getClassName(Class);
        if ( annotate(Class).toString().toLowerCase()!=Class.$inject.toString().toLowerCase() )
        {
            var err = ("\n\nPlease check the injection in class $className$\n\n").replace('$className$',className);
            throw new Error(err);
            return;
        }
        console.log('$di class checked: '+className)
    };

    /** INTERNAL **/
    function getClassName(Class:any):string
    {
        return Class.toString().match(/function (.*)\(/)[1];
    }

    //http://taoofcode.net/studying-the-angular-injector-annotate/
    var FN_ARGS:RegExp = /^function\s*[^\(]*\(\s*([^\)]*)\)/m;
    var FN_ARG_SPLIT:RegExp = /,/;
    var FN_ARG:RegExp = /^\s*(_?)(\S+?)\1\s*$/;
    var STRIP_COMMENTS:RegExp = /((\/\/.*$)|(\/\*[\s\S]*?\*\/))/mg;

    function annotate(fn:Function):string[]
    {
        var $inject:string[];
        var fnText:string;
        var argDecl:any[];

        if (typeof fn == 'function') {

            $inject = [];
            if (fn.length) {
                fnText = fn.toString().replace(STRIP_COMMENTS, '');
                argDecl = fnText.match(FN_ARGS);
                argDecl[1].split(FN_ARG_SPLIT).forEach(function(arg){
                    arg.replace(FN_ARG, function(all, underscore, name){
                        $inject.push(name);
                    });
                });
            }
        }
        return $inject;
    }
}</pre></div><ul>
<li>Thanks to Alejandro for his help :P</li>
</ul>


        </section>
    </article>
	<div id="disqus_thread"></div>
	<script type="text/javascript">
		/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
		var disqus_shortname = 'xperiments'; // required: replace example with your forum shortname

		var disqus_identifier = 'Typescript AngularJS Best Practices';
		var disqus_title = 'Typescript AngularJS Best Practices';
		var disqus_url = 'http://xperiments.io/posts/typescript-angularjs-best-practices/';

		/* * * DON'T EDIT BELOW THIS LINE * * */
		(function() {
			var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
			dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
			(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
		})();
	</script>
	<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
	<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</main>


    <footer class="site-footer">
        <div class="inner">
            <section class="copyright">&copy; <a href="http://www.xperiments.io/">xperiments.io</a> 2014</section>
        </div>
    </footer>
    </div>
    <script src="/scripts/prism.js" data-manual></script>
    <script src="/scripts/app.js"></script>
	<script>
		(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
			(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
				m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,'script','//www.google-analytics.com/analytics.js','ga');

		ga('create', 'UA-4009710-5', 'xperiments.io');
		ga('send', 'pageview');

	</script>
  </body>
</html>

